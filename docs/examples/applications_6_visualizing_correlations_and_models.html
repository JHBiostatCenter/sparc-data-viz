<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erik Westlund">
<meta name="dcterms.date" content="2025-06-12">

<title>Application 6: Visualizing Correlations and Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#looking-at-data-correlations" id="toc-looking-at-data-correlations" class="nav-link active" data-scroll-target="#looking-at-data-correlations">Looking At Data: Correlations</a></li>
  <li><a href="#visualizing-model-outputs" id="toc-visualizing-model-outputs" class="nav-link" data-scroll-target="#visualizing-model-outputs">Visualizing Model Outputs</a></li>
  <li><a href="#predicted-probabilities-by-covariate-groups" id="toc-predicted-probabilities-by-covariate-groups" class="nav-link" data-scroll-target="#predicted-probabilities-by-covariate-groups">Predicted Probabilities by Covariate Groups</a></li>
  <li><a href="#provider-level-random-effects" id="toc-provider-level-random-effects" class="nav-link" data-scroll-target="#provider-level-random-effects">Provider-Level Random Effects</a></li>
  <li><a href="#interaction-effects" id="toc-interaction-effects" class="nav-link" data-scroll-target="#interaction-effects">Interaction Effects</a>
  <ul class="collapse">
  <li><a href="#interaction-between-categorical-and-continuous-variable" id="toc-interaction-between-categorical-and-continuous-variable" class="nav-link" data-scroll-target="#interaction-between-categorical-and-continuous-variable">Interaction Between Categorical and Continuous Variable</a></li>
  </ul></li>
  <li><a href="#more-complexity-categorical-by-continuous-by-continuous-interaction" id="toc-more-complexity-categorical-by-continuous-by-continuous-interaction" class="nav-link" data-scroll-target="#more-complexity-categorical-by-continuous-by-continuous-interaction">More Complexity: Categorical by Continuous by Continuous Interaction</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Application 6: Visualizing Correlations and Models</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Erik Westlund </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 12, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"broom.mixed"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"kableExtra"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"emmeans"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Install missing packages</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>new_packages <span class="ot">&lt;-</span> required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>])]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(new_packages)) <span class="fu">install.packages</span>(new_packages)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all packages</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (package <span class="cf">in</span> required_packages) {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(package, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"examples"</span>, <span class="st">"colors.R"</span>))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="looking-at-data-correlations" class="level2">
<h2 class="anchored" data-anchor-id="looking-at-data-correlations">Looking At Data: Correlations</h2>
<p>Correlations are indisposable for understanding the relationship between two variables, but they can be misleading as we show below.</p>
<p>This is adapted directly from <a href="https://janhove.github.io/posts/2016-11-21-what-correlations-look-like/">Jan Vanhove</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plot_r <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">showSmoother =</span> <span class="cn">TRUE</span>, <span class="at">smoother =</span> <span class="st">"lm"</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(showSmoother) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> smoother,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> colors<span class="sc">$</span>green<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>title, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">24</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"lines"</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>corr_r <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">r =</span> <span class="fl">0.6</span>, <span class="at">n =</span> <span class="dv">50</span>) {</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  compute.y <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, r) {</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    theta <span class="ot">&lt;-</span> <span class="fu">acos</span>(r)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, y)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    Xctr <span class="ot">&lt;-</span> <span class="fu">scale</span>(X, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)    <span class="co"># Centered variables (mean 0)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    Id <span class="ot">&lt;-</span> <span class="fu">diag</span>(n)                                     <span class="co"># Identity matrix</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    Q <span class="ot">&lt;-</span> <span class="fu">qr.Q</span>(<span class="fu">qr</span>(Xctr[, <span class="dv">1</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>]))            <span class="co"># QR decomposition</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    P <span class="ot">&lt;-</span> <span class="fu">tcrossprod</span>(Q)                                <span class="co"># Projection onto space defined by x1</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    x2o <span class="ot">&lt;-</span> (Id <span class="sc">-</span> P) <span class="sc">%*%</span> Xctr[, <span class="dv">2</span>]                     <span class="co"># x2ctr made orthogonal to x1ctr</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    Xc2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Xctr[, <span class="dv">1</span>], x2o)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> Xc2 <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">colSums</span>(Xc2 <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> Y[, <span class="dv">2</span>] <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">tan</span>(theta)) <span class="sc">*</span> Y[, <span class="dv">1</span>]</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  cases <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">1</span>, <span class="at">title =</span> <span class="st">"(1) Normal x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">2</span>, <span class="at">title =</span> <span class="st">"(2) Uniform x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">3</span>, <span class="at">title =</span> <span class="st">"(3) +-skewed x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">4</span>, <span class="at">title =</span> <span class="st">"(4) --skewed x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>) <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="dv">5000</span>, <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">5</span>, <span class="at">title =</span> <span class="st">"(5) Normal x, +-skewed residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>)),</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">6</span>, <span class="at">title =</span> <span class="st">"(6) Normal x, --skewed residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="sc">-</span><span class="fu">rlnorm</span>(n, <span class="dv">5</span>)),</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">7</span>, <span class="at">title =</span> <span class="st">"(7) Increasing spread"</span>, </span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)) <span class="sc">+</span> <span class="fu">abs</span>(<span class="fu">min</span>(<span class="fu">rnorm</span>(n))), </span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">abs</span>(<span class="dv">10</span> <span class="sc">*</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)))))),</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">8</span>, <span class="at">title =</span> <span class="st">"(8) Decreasing spread"</span>, </span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)) <span class="sc">+</span> <span class="fu">abs</span>(<span class="fu">min</span>(<span class="fu">rnorm</span>(n))), </span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">pmax</span>(<span class="fl">0.1</span>, <span class="fu">abs</span>(<span class="dv">10</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">sort</span>(<span class="fu">rnorm</span>(n))) <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n))))))),</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">9</span>, <span class="at">title =</span> <span class="st">"(9) Quadratic trend"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rnorm</span>(n) <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">10</span>, <span class="at">title =</span> <span class="st">"(10) Sinusoid relationship"</span>, <span class="at">x =</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi, <span class="dv">2</span> <span class="sc">*</span> pi), <span class="at">y =</span> <span class="fu">sin</span>(<span class="fu">runif</span>(n, <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi, <span class="dv">2</span> <span class="sc">*</span> pi))),</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">11</span>, <span class="at">title =</span> <span class="st">"(11) A single positive outlier"</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">10</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">15</span>)),</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">12</span>, <span class="at">title =</span> <span class="st">"(12) A single negative outlier"</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">10</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="sc">-</span><span class="dv">15</span>)),</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">13</span>, <span class="at">title =</span> <span class="st">"(13) Bimodal residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="sc">-</span><span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">3</span>))),</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">14</span>, <span class="at">title =</span> <span class="st">"(14) Two groups"</span>, </span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">3</span>)), </span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="sc">-</span><span class="dv">3</span>))),</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">15</span>, <span class="at">title =</span> <span class="st">"(15) Sampling at the extremes"</span>, </span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>)), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="dv">10</span>)), </span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">16</span>, <span class="at">title =</span> <span class="st">"(16) Categorical data"</span>, </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">lapply</span>(cases, <span class="cf">function</span>(case) {</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    id <span class="ot">=</span> case<span class="sc">$</span>id</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> case<span class="sc">$</span>x</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">compute.y</span>(x, case<span class="sc">$</span>y, r)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">id =</span> id, <span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">title =</span> case<span class="sc">$</span>title)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>title <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>title, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, <span class="st">") "</span>, <span class="fu">c</span>(</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, normal residuals"</span>,</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uniform x, normal residuals"</span>,</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"+-skewed x, normal residuals"</span>,</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--skewed x, normal residuals"</span>,</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, +-skewed residuals"</span>,</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, --skewed residuals"</span>,</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Increasing spread"</span>,</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Decreasing spread"</span>,</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Quadratic trend"</span>,</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinusoid relationship"</span>,</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A single positive outlier"</span>,</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A single negative outlier"</span>,</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bimodal residuals"</span>,</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two groups"</span>,</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sampling at the extremes"</span>,</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Categorical data"</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">corr_r</span>(<span class="at">r=</span><span class="fl">0.3</span>, <span class="at">n=</span><span class="dv">100</span>)</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> analysis_data)</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ x, data = analysis_data)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.19848 -0.07113 -0.00910  0.06042  0.34241 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept) -0.00313    0.01015  -0.308  0.75846   
x            0.03463    0.01112   3.113  0.00243 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.101 on 98 degrees of freedom
Multiple R-squared:   0.09, Adjusted R-squared:  0.08071 
F-statistic: 9.692 on 1 and 98 DF,  p-value: 0.002426</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(analysis_data<span class="sc">$</span>x, analysis_data<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_r</span>(data, <span class="at">showSmoother=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/plot_correlations-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_r</span>(data, <span class="at">showSmoother=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/plot_correlations-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualizing-model-outputs" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-model-outputs">Visualizing Model Outputs</h2>
<p>Visualization of model outputs is often neglected, but it can be a powerful way both to undrestand and to communicate the results of a model. A number of packages exist to help with this, including <code>broom.mixed</code>, <code>emmeans</code>, and <code>ggeffects</code>.</p>
<p>Here, we fit a logistic mixed-effects model using the glmer() function to estimate the odds of receiving comprehensive postnatal care. This model accounts for both fixed effects (individual-level predictors like race or insurance status) and a random intercept for provider, which captures unobserved heterogeneity across providers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed"</span>, <span class="st">"simulated_data.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 50000 Columns: 20
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (6): state, self_report_income, edu, race_ethnicity, insurance, job_type
dbl (14): id, provider_id, received_comprehensive_postnatal_care, age, depen...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample 1/4 of the sites</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>unique_sites <span class="ot">&lt;-</span> <span class="fu">unique</span>(data<span class="sc">$</span>provider_id)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>reduced_sites <span class="ot">&lt;-</span> <span class="fu">sample</span>(unique_sites, <span class="fu">length</span>(unique_sites) <span class="sc">*</span> <span class="fl">0.10</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>provider_id <span class="sc">%in%</span> reduced_sites, ]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glmer</span>(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  received_comprehensive_postnatal_care <span class="sc">~</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    race_ethnicity <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(distance_to_provider) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    insurance <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    multiple_gestation <span class="sc">+</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    placenta_previa <span class="sc">+</span> </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    gest_hypertension <span class="sc">+</span> </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    preeclampsia <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">|</span> provider_id),  </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data, </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">glmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="fl">1e5</span>))</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create variable labels for better visualization</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>variable_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityaian"</span> <span class="ot">=</span> <span class="st">"AIAN"</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityasian"</span> <span class="ot">=</span> <span class="st">"Asian"</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityblack"</span> <span class="ot">=</span> <span class="st">"Black"</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityhispanic"</span> <span class="ot">=</span> <span class="st">"Hispanic"</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicitynhpi"</span> <span class="ot">=</span> <span class="st">"NHPI"</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityother"</span> <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(distance_to_provider)"</span> <span class="ot">=</span> <span class="st">"Log(Distance to Provider)"</span>,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"insuranceprivate"</span> <span class="ot">=</span> <span class="st">"Insurance: Private"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"insurancestate_provided"</span> <span class="ot">=</span> <span class="st">"Insurance: State-Provided"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"multiple_gestation"</span> <span class="ot">=</span> <span class="st">"Multiple Gestation"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"placenta_previa"</span> <span class="ot">=</span> <span class="st">"Placenta Previa"</span>,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gest_hypertension"</span> <span class="ot">=</span> <span class="st">"Gestational Hypertension"</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"preeclampsia"</span> <span class="ot">=</span> <span class="st">"Preeclampsia"</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"(Intercept)"</span> <span class="ot">=</span> <span class="st">"Intercept"</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below, we extract the fixed-effect estimates using <code>broom.mixed::tidy()</code>, including 95% confidence intervals, and plot them as a coefficient plot (a forest plot for regression coefficients).</p>
<p>Each point shows the estimated log-odds of receiving comprehensive care associated with a given covariate, holding other variables constant. The dashed vertical line at 0 represents no effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get fixed effects with confidence intervals</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>fixed_effects <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any NA values</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(estimate)) <span class="sc">|&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a more readable term name</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercept"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"age"</span> <span class="sc">~</span> <span class="st">"Age"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"sexMale"</span> <span class="sc">~</span> <span class="st">"Male Sex"</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceBlack"</span> <span class="sc">~</span> <span class="st">"Black Race"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceHispanic"</span> <span class="sc">~</span> <span class="st">"Hispanic Race"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceOther"</span> <span class="sc">~</span> <span class="st">"Other Race"</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insurancePrivate"</span> <span class="sc">~</span> <span class="st">"Private Insurance"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insuranceMedicaid"</span> <span class="sc">~</span> <span class="st">"Medicaid"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insuranceOther"</span> <span class="sc">~</span> <span class="st">"Other Insurance"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"comorbidity_score"</span> <span class="sc">~</span> <span class="st">"Comorbidity Score"</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"emergency_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Emergency Admission"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"weekend_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Weekend Admission"</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"night_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Night Admission"</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fixed_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> <span class="fu">reorder</span>(term, estimate))) <span class="sc">+</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> colors<span class="sc">$</span>red<span class="sc">$</span><span class="st">`</span><span class="at">600</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Fixed Effects from GLMM"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each point represents the estimated effect on log-odds of receiving comprehensive care"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Size (95% CI)"</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predictor"</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/fixed_effects-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predicted-probabilities-by-covariate-groups" class="level2">
<h2 class="anchored" data-anchor-id="predicted-probabilities-by-covariate-groups">Predicted Probabilities by Covariate Groups</h2>
<p>Here, we use the emmeans package to estimate marginal predicted probabilities for selected covariates. These represent the expected probability of receiving comprehensive care for each level of a covariate, averaging over the distribution of other covariates in the model. This approach helps isolate the relationship between each covariate and the outcome while controlling for confounding. We visualize these estimates and their 95% confidence intervals, grouped by domain (e.g., race/ethnicity, insurance, medical conditions).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate predicted probabilities for each covariate group</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Race/Ethnicity</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>race_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> race_ethnicity, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>race_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(race_probs) <span class="sc">|&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Race/Ethnicity"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"aian"</span> <span class="sc">~</span> <span class="st">"AIAN"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"asian"</span> <span class="sc">~</span> <span class="st">"Asian"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"black"</span> <span class="sc">~</span> <span class="st">"Black"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"hispanic"</span> <span class="sc">~</span> <span class="st">"Hispanic"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"nhpi"</span> <span class="sc">~</span> <span class="st">"NHPI"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"other"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"white"</span> <span class="sc">~</span> <span class="st">"White"</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Insurance</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>insurance_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> insurance, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>insurance_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(insurance_probs) <span class="sc">|&gt;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Insurance"</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"medicaid"</span> <span class="sc">~</span> <span class="st">"Medicaid"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"private"</span> <span class="sc">~</span> <span class="st">"Private"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"state_provided"</span> <span class="sc">~</span> <span class="st">"State-Provided"</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"uninsured"</span> <span class="sc">~</span> <span class="st">"Uninsured"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Medical Conditions</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>conditions_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> multiple_gestation <span class="sc">+</span> placenta_previa <span class="sc">+</span> gest_hypertension <span class="sc">+</span> preeclampsia, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>conditions_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(conditions_probs) <span class="sc">|&gt;</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Medical Conditions"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      multiple_gestation <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Multiple Gestation"</span>,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      placenta_previa <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Placenta Previa"</span>,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      gest_hypertension <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Gestational Hypertension"</span>,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>      preeclampsia <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Preeclampsia"</span>,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"No Medical Conditions"</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove duplicates where multiple conditions are true</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(category, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all predictions</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>all_probs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  race_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL),</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  insurance_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL),</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  conditions_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Create faceted plot</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_probs, <span class="fu">aes</span>(<span class="at">x =</span> prob, <span class="at">y =</span> <span class="fu">reorder</span>(category, prob))) <span class="sc">+</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> asymp.LCL, <span class="at">xmax =</span> asymp.UCL), </span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> group, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Probability of Receiving Comprehensive Care"</span>,</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"By Covariate Groups"</span>,</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predicted Probability (95% CI)"</span>,</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Category"</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/predicted_probabilities-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="provider-level-random-effects" class="level2">
<h2 class="anchored" data-anchor-id="provider-level-random-effects">Provider-Level Random Effects</h2>
<p>We visualize the provider-level random intercepts, which represent the estimated deviation of each provider from the overall mean (intercept) after accounting for the fixed effects in the model. This helps reveal between-provider variability and can identify providers whose outcomes are systematically higher or lower than expected. The dashed vertical line at zero indicates the overall average; providers to the right have higher-than-average effects, and those to the left are lower.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get random effects</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model, <span class="at">condVar =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>random_effects_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(random_effects)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot of random effects</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(random_effects_data, <span class="fu">aes</span>(<span class="at">x =</span> condval, <span class="at">y =</span> <span class="fu">reorder</span>(grp, condval))) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> condval <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">attr</span>(random_effects<span class="sc">$</span>provider_id, <span class="st">"postVar"</span>)[<span class="dv">1</span>,<span class="dv">1</span>,]), </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">xmax =</span> condval <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">attr</span>(random_effects<span class="sc">$</span>provider_id, <span class="st">"postVar"</span>)[<span class="dv">1</span>,<span class="dv">1</span>,])), </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> colors<span class="sc">$</span>red<span class="sc">$</span><span class="st">`</span><span class="at">600</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Random Effects by Provider"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each point represents the provider-specific deviation from the overall intercept"</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Provider-Specific Effect (95% CI)"</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Provider ID"</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/random_effects-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print model summary</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula: 
received_comprehensive_postnatal_care ~ race_ethnicity + log(distance_to_provider) +  
    insurance + multiple_gestation + placenta_previa + gest_hypertension +  
    preeclampsia + (1 | provider_id)
   Data: data
Control: glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e+05))

      AIC       BIC    logLik -2*log(L)  df.resid 
   5679.3    5776.5   -2824.7    5649.3      4782 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3504 -0.6684 -0.5330  1.1475  3.0147 

Random effects:
 Groups      Name        Variance Std.Dev.
 provider_id (Intercept) 0.2053   0.4531  
Number of obs: 4797, groups:  provider_id, 50

Fixed effects:
                          Estimate Std. Error z value Pr(&gt;|z|)   
(Intercept)               -1.19650    0.40041  -2.988  0.00281 **
race_ethnicityasian        0.36808    0.41330   0.891  0.37315   
race_ethnicityblack       -0.21309    0.40567  -0.525  0.59939   
race_ethnicityhispanic     0.11511    0.39780   0.289  0.77230   
race_ethnicitynhpi         0.07320    0.80323   0.091  0.92739   
race_ethnicityother        0.54133    0.52931   1.023  0.30645   
race_ethnicitywhite        0.23508    0.39261   0.599  0.54933   
log(distance_to_provider) -0.02094    0.02519  -0.831  0.40585   
insuranceprivate           0.18922    0.07774   2.434  0.01493 * 
insurancestate_provided    0.15031    0.08768   1.714  0.08648 . 
multiple_gestation         0.22298    0.20185   1.105  0.26930   
placenta_previa            0.10400    0.30208   0.344  0.73063   
gest_hypertension          0.23839    0.14268   1.671  0.09477 . 
preeclampsia               0.30954    0.22275   1.390  0.16463   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 14 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
</div>
</section>
<section id="interaction-effects" class="level2">
<h2 class="anchored" data-anchor-id="interaction-effects">Interaction Effects</h2>
<p>The <code>emmeans</code> package can also be used to help visualize interaction effects. Let’s simulate some data with an interaction effect.</p>
<section id="interaction-between-categorical-and-continuous-variable" class="level3">
<h3 class="anchored" data-anchor-id="interaction-between-categorical-and-continuous-variable">Interaction Between Categorical and Continuous Variable</h3>
<p>In this example, we simulate data to study how different exercise programs might be more or less effective depending on a person’s starting fitness level. We have:</p>
<ul>
<li>A categorical predictor: Type of exercise program
<ul>
<li>High-Intensity Interval Training (HIIT): Short bursts of intense exercise followed by rest</li>
<li>Strength Training: Weight lifting and resistance exercises</li>
<li>Cardio: Steady-state aerobic exercise like jogging or cycling</li>
</ul></li>
<li>A continuous predictor: Baseline fitness level (on a 1-10 scale)</li>
<li>An outcome: Weight loss in pounds</li>
</ul>
<p>The key question is whether the effectiveness of each program depends on how fit someone is when they start. For example, HIIT might be more effective for people who are already somewhat fit, while Cardio might be better for beginners. The relationship between program type and weight loss changes depends on baseline fitness.</p>
<p>Each program has:</p>
<ul>
<li>A baseline effectiveness (how much weight loss we expect at average fitness levels)</li>
<li>A different rate of effectiveness based on baseline fitness (how much more or less effective it becomes as fitness changes)</li>
<li>Some random variation to account for individual differences</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data with an interaction effect</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data for program × fitness interaction</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ix_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Categorical predictor: Exercise program type</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">program =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"HIIT"</span>, <span class="st">"Strength Training"</span>, <span class="st">"Cardio"</span>), </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continuous predictor: Baseline fitness level (1-10 scale)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_fitness =</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some noise</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create interaction effect</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Center the baseline fitness</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_fitness_centered =</span> baseline_fitness <span class="sc">-</span> <span class="fu">mean</span>(baseline_fitness),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different slopes for different programs</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">fitness_effect =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"HIIT"</span> <span class="sc">~</span> <span class="fl">0.8</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Strength Training"</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Cardio"</span> <span class="sc">~</span> <span class="fl">0.3</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different intercepts for different programs</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">program_effect =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"HIIT"</span> <span class="sc">~</span> <span class="fl">8.0</span>,</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Strength Training"</span> <span class="sc">~</span> <span class="fl">6.0</span>,</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Cardio"</span> <span class="sc">~</span> <span class="fl">4.0</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate outcome: Weight loss in pounds</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight_loss =</span> program_effect <span class="sc">+</span> (fitness_effect <span class="sc">*</span> baseline_fitness_centered) <span class="sc">+</span> error</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s fit a model to the simulated data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(weight_loss <span class="sc">~</span> program <span class="sc">*</span> baseline_fitness_centered, <span class="at">data =</span> ix_data)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">tidy</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 56%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">4.1573036</td>
<td style="text-align: right;">0.1628360</td>
<td style="text-align: right;">25.530615</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">programHIIT</td>
<td style="text-align: right;">3.7323100</td>
<td style="text-align: right;">0.2285624</td>
<td style="text-align: right;">16.329498</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">programStrength Training</td>
<td style="text-align: right;">1.9190550</td>
<td style="text-align: right;">0.2283159</td>
<td style="text-align: right;">8.405262</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">baseline_fitness_centered</td>
<td style="text-align: right;">0.2963606</td>
<td style="text-align: right;">0.0643186</td>
<td style="text-align: right;">4.607698</td>
<td style="text-align: right;">0.0000052</td>
</tr>
<tr class="odd">
<td style="text-align: left;">programHIIT:baseline_fitness_centered</td>
<td style="text-align: right;">0.4923781</td>
<td style="text-align: right;">0.0884914</td>
<td style="text-align: right;">5.564134</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">programStrength Training:baseline_fitness_centered</td>
<td style="text-align: right;">0.2588035</td>
<td style="text-align: right;">0.0920493</td>
<td style="text-align: right;">2.811576</td>
<td style="text-align: right;">0.0051260</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We get results back. We have “main effects” for the program type and the baseline fitness level, and an interaction effect between the two.</p>
<p>Centering helps: The intercept represents the expected weight loss when baseline fitness is at its mean.</p>
<p>The <code>emmeans</code> package can help us interpret. Let’s get it to give us the predicted weight loss at the average fitness level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the interaction</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model, <span class="sc">~</span> program <span class="sc">|</span> baseline_fitness_centered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>baseline_fitness_centered = 1.28e-16:
 program           emmean    SE  df lower.CL upper.CL
 Cardio              4.16 0.163 494     3.84     4.48
 HIIT                7.89 0.160 494     7.57     8.20
 Strength Training   6.08 0.160 494     5.76     6.39

Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>We see that this lines up with our model results:</p>
<ul>
<li>Cardio: 4.16 lbs (intercept)</li>
<li>HIIT: 7.89 lbs (4.16 + 3.73 = 7.89)</li>
<li>Strength Training: 6.08 lbs (4.16 + 1.92 = 6.08)</li>
</ul>
<p>But what if we want to see the relationship between program type and weight loss at different baseline fitness levels? Let’s create a plot that shows how weight loss changes across the full range of baseline fitness for each program.</p>
<p>We can use <code>emmip()</code> (expected means interaction plot)to plot the predicted weight loss by program type at different baseline fitness levels. We add some text to the plot to show the slopes for each program.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create baseline fitness values in the original (uncentered) scale</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get centered values based on the observed data range</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>centered_range <span class="ot">&lt;-</span> <span class="fu">range</span>(ix_data<span class="sc">$</span>baseline_fitness <span class="sc">-</span> <span class="fu">mean</span>(ix_data<span class="sc">$</span>baseline_fitness))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>centered_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(centered_range[<span class="dv">1</span>], centered_range[<span class="dv">2</span>], <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="fu">emmip</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  program <span class="sc">~</span> baseline_fitness_centered,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">baseline_fitness_centered =</span> centered_vals),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Weight Loss by Program and Baseline Fitness"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Baseline Fitness Level (Centered)"</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Weight Loss (pounds)"</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Program Type"</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">4.5</span>, <span class="at">label =</span> <span class="st">"Cardio slope: 0.30"</span>, <span class="at">color =</span> <span class="st">"#F8766D"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">10.5</span>, <span class="at">label =</span> <span class="st">"HIIT slope: 0.79"</span>, <span class="at">color =</span> <span class="st">"#00BA38"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">7.5</span>, <span class="at">label =</span> <span class="st">"Strength slope: 0.56"</span>, <span class="at">color =</span> <span class="st">"#619CFF"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/interaction_plot_2-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>I find this a lot easier to interpret than the table of results. “Seeing is believing.”</p>
</section>
</section>
<section id="more-complexity-categorical-by-continuous-by-continuous-interaction" class="level2">
<h2 class="anchored" data-anchor-id="more-complexity-categorical-by-continuous-by-continuous-interaction">More Complexity: Categorical by Continuous by Continuous Interaction</h2>
<p>Let’s simulate data to get a sense of a complex set of interactions.</p>
<p>We will create a simulated dataset that explores how lung function is influenced by age, air pollution exposure, and smoking status. Both age and pollution independently reduce lung function, but the negative effect of pollution becomes more pronounced as people get older, so pollution is more damaging to lung function in older adults than in younger ones. Moreover, smoking increases the effect of pollution on lung function.</p>
<ul>
<li><code>fev1</code> = forced expiratory volume in one second</li>
<li><code>age</code> = age, which can be 30-80</li>
<li><code>pm25</code> = particulate matter exposure</li>
<li><code>is_smoker</code> = whether the person is a smoker</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">30</span>, <span class="dv">80</span>)              <span class="co"># Age 30–80</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>pm25 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">5</span>, <span class="dv">35</span>)              <span class="co"># PM2.5 range</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>interaction_effect <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.01</span>          <span class="co"># Base moderation: steeper slope with age</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add smoking status (binary)</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># More likely to have smoking history as age increases</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>smoking_prob <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="sc">+</span> (age <span class="sc">-</span> <span class="dv">30</span>)<span class="sc">/</span><span class="dv">100</span>  <span class="co"># Probability increases with age</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>is_smoker <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, smoking_prob)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create age-dependent error term (more variation with age)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>age_error <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">0.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> (age <span class="sc">-</span> <span class="dv">30</span>)<span class="sc">/</span><span class="dv">50</span>))  <span class="co"># Error increases with age</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome: base lung function + age effect + pollution effect + </span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># two-way interactions + three-way interaction + smoking effect</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Please note how are simulated data looks like the model we are going to estimate.</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulating data is a great way to undrestand how models work.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co"># In fact, if you uncenter the below model, you will see that the coefficients are very close to what we define below.</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>fev1 <span class="ot">&lt;-</span> <span class="fl">4.5</span> <span class="sc">-</span> <span class="co"># intercept</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.02</span><span class="sc">*</span>age <span class="sc">-</span> <span class="co"># age effect</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.03</span><span class="sc">*</span>pm25 <span class="sc">+</span> <span class="co"># pollution effect</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        interaction_effect <span class="sc">*</span> age <span class="sc">*</span> pm25 <span class="sc">-</span>  <span class="co"># age × pollution</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.5</span><span class="sc">*</span>is_smoker <span class="sc">+</span>                    <span class="co"># smoking main effect</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.02</span><span class="sc">*</span>age<span class="sc">*</span>is_smoker <span class="sc">+</span>               <span class="co"># age × smoking</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.01</span><span class="sc">*</span>pm25<span class="sc">*</span>is_smoker <span class="sc">+</span>              <span class="co"># pollution × smoking</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fl">0.005</span><span class="sc">*</span>age<span class="sc">*</span>pm25<span class="sc">*</span>is_smoker <span class="sc">+</span>        <span class="co"># three-way interaction</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        age_error</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(age, pm25, fev1, is_smoker)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">age</th>
<th style="text-align: right;">pm25</th>
<th style="text-align: right;">fev1</th>
<th style="text-align: right;">is_smoker</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">44.37888</td>
<td style="text-align: right;">28.537258</td>
<td style="text-align: right;">-9.5398588</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">69.41526</td>
<td style="text-align: right;">5.282897</td>
<td style="text-align: right;">-0.3395903</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">50.44885</td>
<td style="text-align: right;">28.371976</td>
<td style="text-align: right;">-11.5508085</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">74.15087</td>
<td style="text-align: right;">26.881720</td>
<td style="text-align: right;">-26.1678392</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">77.02336</td>
<td style="text-align: right;">23.903956</td>
<td style="text-align: right;">-23.7395757</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">32.27782</td>
<td style="text-align: right;">19.427325</td>
<td style="text-align: right;">-6.3510524</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A starting point for an interaction analysis is to color code by group and look at the trends. Let’s create age bins and plot out the trends, faceting by smoker status.</p>
<p>We clearly see a slope difference by age. We also see that all the slopes of smokers appear to be steeper than the slopes of non-smokers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>), </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70+"</span>)),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> fev1, <span class="at">color =</span> age_group)) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> smoking_status) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Lung Function by Air Pollution and Age Group"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Faceted by Smoking Status"</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PM2.5 Exposure"</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"FEV1 (L)"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Age Group"</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/continuous_interaction_plot_2-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show variation by age group and smoking status</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>), </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70+"</span>)),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, smoking_status) <span class="sc">|&gt;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_fev1 =</span> <span class="fu">mean</span>(fev1),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_fev1 =</span> <span class="fu">sd</span>(fev1),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_fev1 =</span> <span class="fu">min</span>(fev1),</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_fev1 =</span> <span class="fu">max</span>(fev1),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'age_group'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 21%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">age_group</th>
<th style="text-align: left;">smoking_status</th>
<th style="text-align: right;">mean_fev1</th>
<th style="text-align: right;">sd_fev1</th>
<th style="text-align: right;">min_fev1</th>
<th style="text-align: right;">max_fev1</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">30-39</td>
<td style="text-align: left;">Non-smoker</td>
<td style="text-align: right;">-3.868944</td>
<td style="text-align: right;">3.220115</td>
<td style="text-align: right;">-9.858047</td>
<td style="text-align: right;">0.9199290</td>
<td style="text-align: right;">40</td>
</tr>
<tr class="even">
<td style="text-align: left;">30-39</td>
<td style="text-align: left;">Smoker</td>
<td style="text-align: right;">-7.520161</td>
<td style="text-align: right;">4.991676</td>
<td style="text-align: right;">-15.763336</td>
<td style="text-align: right;">0.4955185</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">40-49</td>
<td style="text-align: left;">Non-smoker</td>
<td style="text-align: right;">-6.433924</td>
<td style="text-align: right;">4.233292</td>
<td style="text-align: right;">-13.192217</td>
<td style="text-align: right;">0.5287203</td>
<td style="text-align: right;">43</td>
</tr>
<tr class="even">
<td style="text-align: left;">40-49</td>
<td style="text-align: left;">Smoker</td>
<td style="text-align: right;">-11.018059</td>
<td style="text-align: right;">6.030700</td>
<td style="text-align: right;">-20.044162</td>
<td style="text-align: right;">-0.5861045</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">50-59</td>
<td style="text-align: left;">Non-smoker</td>
<td style="text-align: right;">-8.334104</td>
<td style="text-align: right;">5.279194</td>
<td style="text-align: right;">-17.175684</td>
<td style="text-align: right;">0.4095706</td>
<td style="text-align: right;">45</td>
</tr>
<tr class="even">
<td style="text-align: left;">50-59</td>
<td style="text-align: left;">Smoker</td>
<td style="text-align: right;">-13.701037</td>
<td style="text-align: right;">8.796267</td>
<td style="text-align: right;">-27.544445</td>
<td style="text-align: right;">-0.4953899</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">60-69</td>
<td style="text-align: left;">Non-smoker</td>
<td style="text-align: right;">-9.396839</td>
<td style="text-align: right;">6.462022</td>
<td style="text-align: right;">-21.041806</td>
<td style="text-align: right;">-0.3395903</td>
<td style="text-align: right;">28</td>
</tr>
<tr class="even">
<td style="text-align: left;">60-69</td>
<td style="text-align: left;">Smoker</td>
<td style="text-align: right;">-16.031041</td>
<td style="text-align: right;">8.681144</td>
<td style="text-align: right;">-30.743716</td>
<td style="text-align: right;">-1.9684067</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="odd">
<td style="text-align: left;">70+</td>
<td style="text-align: left;">Non-smoker</td>
<td style="text-align: right;">-11.475683</td>
<td style="text-align: right;">7.039974</td>
<td style="text-align: right;">-20.919413</td>
<td style="text-align: right;">-0.8792988</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">70+</td>
<td style="text-align: left;">Smoker</td>
<td style="text-align: right;">-16.826588</td>
<td style="text-align: right;">9.214377</td>
<td style="text-align: right;">-33.283871</td>
<td style="text-align: right;">-1.8593214</td>
<td style="text-align: right;">37</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now let’s center our variables and fit a model with the three-way interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25_centered =</span> pm25 <span class="sc">-</span> <span class="fu">mean</span>(pm25),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_centered =</span> age <span class="sc">-</span> <span class="fu">mean</span>(age)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(fev1 <span class="sc">~</span> pm25_centered <span class="sc">*</span> age_centered <span class="sc">*</span> is_smoker, <span class="at">data =</span> data)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">tidy</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 48%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 14%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-8.1597223</td>
<td style="text-align: right;">0.0230908</td>
<td style="text-align: right;">-353.37484</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">pm25_centered</td>
<td style="text-align: right;">-0.5730489</td>
<td style="text-align: right;">0.0025919</td>
<td style="text-align: right;">-221.09554</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age_centered</td>
<td style="text-align: right;">-0.2173991</td>
<td style="text-align: right;">0.0017101</td>
<td style="text-align: right;">-127.12552</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">is_smoker</td>
<td style="text-align: right;">-4.7052941</td>
<td style="text-align: right;">0.0363237</td>
<td style="text-align: right;">-129.53798</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pm25_centered:age_centered</td>
<td style="text-align: right;">-0.0099022</td>
<td style="text-align: right;">0.0001941</td>
<td style="text-align: right;">-51.02526</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">pm25_centered:is_smoker</td>
<td style="text-align: right;">-0.2686729</td>
<td style="text-align: right;">0.0041309</td>
<td style="text-align: right;">-65.04034</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age_centered:is_smoker</td>
<td style="text-align: right;">-0.0783907</td>
<td style="text-align: right;">0.0025621</td>
<td style="text-align: right;">-30.59665</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">pm25_centered:age_centered:is_smoker</td>
<td style="text-align: right;">-0.0048553</td>
<td style="text-align: right;">0.0003050</td>
<td style="text-align: right;">-15.91835</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We see that the interaction terms in our regression model are statistically significant, but interpreting them directly from the table is very difficult. This is especially true in models with two or more continuous predictors interacting, and even more so when one of them is also interacting with a binary group.</p>
<p>Take the main effects: <code>pm25_centered</code> and <code>age_centered</code>. These coefficients only describe the effect of PM2.5 or age at the average level of the other variable. For example, the coefficient for PM2.5 tells us how pollution affects FEV1 only at the mean age in our sample. That’s not very useful unless you already know what the mean is, and even then, it’s just a narrow slice of the story.</p>
<p>Now add in interaction terms like <code>pm25</code> × <code>age</code> or <code>pm25</code> × <code>age</code> × <code>is_smoker</code>, and things get more abstract. What does a coefficient of –0.01 for <code>pm25</code> × <code>age</code> actually mean? Technically, it means the effect of PM2.5 on lung function gets more negative as age increases, but:</p>
<ul>
<li>How much more?</li>
<li>Is that change clinically meaningful?</li>
<li>Does the slope actually flip direction at some point?</li>
<li>Is the effect stronger in smokers than non-smokers?</li>
</ul>
<p>You could try to work this out by multiplying coefficients in your head, but if you’re like me, then you’re not smart enough. Better to use visualization to help.</p>
<p><code>emmeans</code> can help us by generating predicted values and estimated trends. It also allows us to probe the model and “un-center” the data for interpretation.</p>
<p>For example, we can explore how the slope of PM2.5 on FEV1 changes at different ages, and see how those slopes differ by smoking status. Using <code>emtrends()</code>, we can even extract the actual slope estimates by subgroup, turning abstract interactions into tangible comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get centering values</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>mean_age <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>age)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>mean_pm25 <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>pm25)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define values for uncentered age and PM2.5</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>age_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>pm25_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">35</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Centered versions to use in emmip</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>age_centered_vals <span class="ot">&lt;-</span> age_vals <span class="sc">-</span> mean_age</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>pm25_centered_vals <span class="ot">&lt;-</span> pm25_vals <span class="sc">-</span> mean_pm25</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get predicted values with emmip, grouped by smoking status</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">emmip</span>(</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  age_centered <span class="sc">~</span> pm25_centered <span class="sc">|</span> is_smoker,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_centered =</span> age_centered_vals,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25_centered =</span> pm25_centered_vals,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_smoker =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">plotit =</span> <span class="cn">FALSE</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncenter for plotting</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> pred_data <span class="sc">|&gt;</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age_centered <span class="sc">+</span> mean_age,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25 =</span> pm25_centered <span class="sc">+</span> mean_pm25,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoker_label =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get slopes of PM2.5 at each age × smoking status</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>slopes <span class="ot">&lt;-</span> <span class="fu">emtrends</span>(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> age_centered <span class="sc">*</span> is_smoker,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> <span class="st">"pm25_centered"</span>,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">age_centered =</span> age_centered_vals, <span class="at">is_smoker =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age_centered <span class="sc">+</span> mean_age,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoker_label =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>),</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Slope: "</span>, <span class="fu">round</span>(pm25_centered.trend, <span class="dv">3</span>))</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Plot</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_data, <span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> yvar, <span class="at">color =</span> <span class="fu">factor</span>(age), <span class="at">group =</span> <span class="fu">interaction</span>(age, smoker_label))) <span class="sc">+</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pred_data <span class="sc">|&gt;</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(age, smoker_label) <span class="sc">|&gt;</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(pm25) <span class="sc">|&gt;</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(slopes, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"smoker_label"</span>)),</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> yvar, <span class="at">label =</span> label, <span class="at">color =</span> <span class="fu">factor</span>(age)),</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> smoker_label) <span class="sc">+</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Lung Function by PM2.5 and Age, with Smoking Interaction"</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Slopes of PM2.5 Effect Vary by Age and Smoking Status"</span>,</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PM2.5 (μg/m³)"</span>,</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted FEV1"</span>,</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Age"</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">min</span>(pm25_vals), <span class="fu">max</span>(pm25_vals) <span class="sc">+</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="applications_6_visualizing_correlations_and_models_files/figure-html/continuous_interaction_plot_3-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Application 6: Visualizing Correlations and Models"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Erik Westlund"</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-06-12"</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">  render-on-save: true</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># List of required packages</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"broom.mixed"</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"kableExtra"</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"emmeans"</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Install missing packages</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>new_packages <span class="ot">&lt;-</span> required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>])]</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(new_packages)) <span class="fu">install.packages</span>(new_packages)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all packages</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (package <span class="cf">in</span> required_packages) {</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(package, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"examples"</span>, <span class="st">"colors.R"</span>))</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Looking At Data: Correlations</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>Correlations are indisposable for understanding the relationship between two variables, but they can be misleading as we show below.</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>This is adapted directly from <span class="co">[</span><span class="ot">Jan Vanhove</span><span class="co">](https://janhove.github.io/posts/2016-11-21-what-correlations-look-like/)</span>.</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_correlations}</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 24</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>plot_r <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">showSmoother =</span> <span class="cn">TRUE</span>, <span class="at">smoother =</span> <span class="st">"lm"</span>) {</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(showSmoother) {</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> smoother,</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> colors<span class="sc">$</span>green<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>,</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>,</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.3</span>,</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>title, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">24</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"lines"</span>)</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>corr_r <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">r =</span> <span class="fl">0.6</span>, <span class="at">n =</span> <span class="dv">50</span>) {</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>  compute.y <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, r) {</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>    theta <span class="ot">&lt;-</span> <span class="fu">acos</span>(r)</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, y)</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    Xctr <span class="ot">&lt;-</span> <span class="fu">scale</span>(X, <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>)    <span class="co"># Centered variables (mean 0)</span></span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>    Id <span class="ot">&lt;-</span> <span class="fu">diag</span>(n)                                     <span class="co"># Identity matrix</span></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>    Q <span class="ot">&lt;-</span> <span class="fu">qr.Q</span>(<span class="fu">qr</span>(Xctr[, <span class="dv">1</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>]))            <span class="co"># QR decomposition</span></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>    P <span class="ot">&lt;-</span> <span class="fu">tcrossprod</span>(Q)                                <span class="co"># Projection onto space defined by x1</span></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>    x2o <span class="ot">&lt;-</span> (Id <span class="sc">-</span> P) <span class="sc">%*%</span> Xctr[, <span class="dv">2</span>]                     <span class="co"># x2ctr made orthogonal to x1ctr</span></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>    Xc2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Xctr[, <span class="dv">1</span>], x2o)</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> Xc2 <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">colSums</span>(Xc2 <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> Y[, <span class="dv">2</span>] <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">tan</span>(theta)) <span class="sc">*</span> Y[, <span class="dv">1</span>]</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>  cases <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">1</span>, <span class="at">title =</span> <span class="st">"(1) Normal x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">2</span>, <span class="at">title =</span> <span class="st">"(2) Uniform x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">3</span>, <span class="at">title =</span> <span class="st">"(3) +-skewed x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>), <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">4</span>, <span class="at">title =</span> <span class="st">"(4) --skewed x, normal residuals"</span>, <span class="at">x =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>) <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="dv">5000</span>, <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">5</span>, <span class="at">title =</span> <span class="st">"(5) Normal x, +-skewed residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rlnorm</span>(n, <span class="dv">5</span>)),</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">6</span>, <span class="at">title =</span> <span class="st">"(6) Normal x, --skewed residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="sc">-</span><span class="fu">rlnorm</span>(n, <span class="dv">5</span>)),</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">7</span>, <span class="at">title =</span> <span class="st">"(7) Increasing spread"</span>, </span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)) <span class="sc">+</span> <span class="fu">abs</span>(<span class="fu">min</span>(<span class="fu">rnorm</span>(n))), </span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">abs</span>(<span class="dv">10</span> <span class="sc">*</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)))))),</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">8</span>, <span class="at">title =</span> <span class="st">"(8) Decreasing spread"</span>, </span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n)) <span class="sc">+</span> <span class="fu">abs</span>(<span class="fu">min</span>(<span class="fu">rnorm</span>(n))), </span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">pmax</span>(<span class="fl">0.1</span>, <span class="fu">abs</span>(<span class="dv">10</span> <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">sort</span>(<span class="fu">rnorm</span>(n))) <span class="sc">-</span> <span class="dv">10</span> <span class="sc">*</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(n))))))),</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">9</span>, <span class="at">title =</span> <span class="st">"(9) Quadratic trend"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">rnorm</span>(n) <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">10</span>, <span class="at">title =</span> <span class="st">"(10) Sinusoid relationship"</span>, <span class="at">x =</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi, <span class="dv">2</span> <span class="sc">*</span> pi), <span class="at">y =</span> <span class="fu">sin</span>(<span class="fu">runif</span>(n, <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> pi, <span class="dv">2</span> <span class="sc">*</span> pi))),</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">11</span>, <span class="at">title =</span> <span class="st">"(11) A single positive outlier"</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">10</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">15</span>)),</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">12</span>, <span class="at">title =</span> <span class="st">"(12) A single negative outlier"</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">10</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(n <span class="sc">-</span> <span class="dv">1</span>), <span class="sc">-</span><span class="dv">15</span>)),</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">13</span>, <span class="at">title =</span> <span class="st">"(13) Bimodal residuals"</span>, <span class="at">x =</span> <span class="fu">rnorm</span>(n), <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="sc">-</span><span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">3</span>))),</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">14</span>, <span class="at">title =</span> <span class="st">"(14) Two groups"</span>, </span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="sc">-</span><span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="dv">3</span>)), </span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="dv">3</span>), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="sc">-</span><span class="dv">3</span>))),</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">15</span>, <span class="at">title =</span> <span class="st">"(15) Sampling at the extremes"</span>, </span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">2</span>)), <span class="fu">rnorm</span>(<span class="fu">ceiling</span>(n <span class="sc">/</span> <span class="dv">2</span>), <span class="at">mean =</span> <span class="dv">10</span>)), </span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">rnorm</span>(n)),</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">id =</span> <span class="dv">16</span>, <span class="at">title =</span> <span class="st">"(16) Categorical data"</span>, </span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">lapply</span>(cases, <span class="cf">function</span>(case) {</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>    id <span class="ot">=</span> case<span class="sc">$</span>id</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> case<span class="sc">$</span>x</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">compute.y</span>(x, case<span class="sc">$</span>y, r)</span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">id =</span> id, <span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">title =</span> case<span class="sc">$</span>title)</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>title <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>title, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>, <span class="st">") "</span>, <span class="fu">c</span>(</span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, normal residuals"</span>,</span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uniform x, normal residuals"</span>,</span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"+-skewed x, normal residuals"</span>,</span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--skewed x, normal residuals"</span>,</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, +-skewed residuals"</span>,</span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Normal x, --skewed residuals"</span>,</span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Increasing spread"</span>,</span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Decreasing spread"</span>,</span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Quadratic trend"</span>,</span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinusoid relationship"</span>,</span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A single positive outlier"</span>,</span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A single negative outlier"</span>,</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bimodal residuals"</span>,</span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Two groups"</span>,</span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sampling at the extremes"</span>,</span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Categorical data"</span></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">corr_r</span>(<span class="at">r=</span><span class="fl">0.3</span>, <span class="at">n=</span><span class="dv">100</span>)</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> analysis_data)</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(analysis_data<span class="sc">$</span>x, analysis_data<span class="sc">$</span>y)</span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_r</span>(data, <span class="at">showSmoother=</span><span class="cn">FALSE</span>)</span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_r</span>(data, <span class="at">showSmoother=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualizing Model Outputs</span></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>Visualization of model outputs is often neglected, but it can be a powerful way both to undrestand and to communicate the results of a model. A number of packages exist to help with this, including <span class="in">`broom.mixed`</span>, <span class="in">`emmeans`</span>, and <span class="in">`ggeffects`</span>.</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>Here, we fit a logistic mixed-effects model using the glmer() function to estimate the odds of receiving comprehensive postnatal care. This model accounts for both fixed effects (individual-level predictors like race or insurance status) and a random intercept for provider, which captures unobserved heterogeneity across providers.</span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model_setup}</span></span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed"</span>, <span class="st">"simulated_data.csv"</span>))</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample 1/4 of the sites</span></span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a>unique_sites <span class="ot">&lt;-</span> <span class="fu">unique</span>(data<span class="sc">$</span>provider_id)</span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a>reduced_sites <span class="ot">&lt;-</span> <span class="fu">sample</span>(unique_sites, <span class="fu">length</span>(unique_sites) <span class="sc">*</span> <span class="fl">0.10</span>)</span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data[data<span class="sc">$</span>provider_id <span class="sc">%in%</span> reduced_sites, ]</span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glmer</span>(</span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>  received_comprehensive_postnatal_care <span class="sc">~</span> </span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a>    race_ethnicity <span class="sc">+</span></span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(distance_to_provider) <span class="sc">+</span></span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>    insurance <span class="sc">+</span></span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>    multiple_gestation <span class="sc">+</span> </span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a>    placenta_previa <span class="sc">+</span> </span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>    gest_hypertension <span class="sc">+</span> </span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>    preeclampsia <span class="sc">+</span></span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">|</span> provider_id),  </span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data, </span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">glmerControl</span>(<span class="at">optimizer =</span> <span class="st">"bobyqa"</span>, <span class="at">optCtrl =</span> <span class="fu">list</span>(<span class="at">maxfun =</span> <span class="fl">1e5</span>))</span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Create variable labels for better visualization</span></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a>variable_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityaian"</span> <span class="ot">=</span> <span class="st">"AIAN"</span>,</span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityasian"</span> <span class="ot">=</span> <span class="st">"Asian"</span>,</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityblack"</span> <span class="ot">=</span> <span class="st">"Black"</span>,</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityhispanic"</span> <span class="ot">=</span> <span class="st">"Hispanic"</span>,</span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicitynhpi"</span> <span class="ot">=</span> <span class="st">"NHPI"</span>,</span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a>  <span class="st">"race_ethnicityother"</span> <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log(distance_to_provider)"</span> <span class="ot">=</span> <span class="st">"Log(Distance to Provider)"</span>,</span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a>  <span class="st">"insuranceprivate"</span> <span class="ot">=</span> <span class="st">"Insurance: Private"</span>,</span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>  <span class="st">"insurancestate_provided"</span> <span class="ot">=</span> <span class="st">"Insurance: State-Provided"</span>,</span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a>  <span class="st">"multiple_gestation"</span> <span class="ot">=</span> <span class="st">"Multiple Gestation"</span>,</span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a>  <span class="st">"placenta_previa"</span> <span class="ot">=</span> <span class="st">"Placenta Previa"</span>,</span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gest_hypertension"</span> <span class="ot">=</span> <span class="st">"Gestational Hypertension"</span>,</span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a>  <span class="st">"preeclampsia"</span> <span class="ot">=</span> <span class="st">"Preeclampsia"</span>,</span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a>  <span class="st">"(Intercept)"</span> <span class="ot">=</span> <span class="st">"Intercept"</span></span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a>Below, we extract the fixed-effect estimates using <span class="in">`broom.mixed::tidy()`</span>, including 95% confidence intervals, and plot them as a coefficient plot (a forest plot for regression coefficients).</span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a>Each point shows the estimated log-odds of receiving comprehensive care associated with a given covariate, holding other variables constant. The dashed vertical line at 0 represents no effect.</span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fixed_effects}</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Get fixed effects with confidence intervals</span></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a>fixed_effects <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(effect <span class="sc">==</span> <span class="st">"fixed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any NA values</span></span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(estimate)) <span class="sc">|&gt;</span></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a more readable term name</span></span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"(Intercept)"</span> <span class="sc">~</span> <span class="st">"Intercept"</span>,</span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"age"</span> <span class="sc">~</span> <span class="st">"Age"</span>,</span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"sexMale"</span> <span class="sc">~</span> <span class="st">"Male Sex"</span>,</span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceBlack"</span> <span class="sc">~</span> <span class="st">"Black Race"</span>,</span>
<span id="cb29-237"><a href="#cb29-237" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceHispanic"</span> <span class="sc">~</span> <span class="st">"Hispanic Race"</span>,</span>
<span id="cb29-238"><a href="#cb29-238" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"raceOther"</span> <span class="sc">~</span> <span class="st">"Other Race"</span>,</span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insurancePrivate"</span> <span class="sc">~</span> <span class="st">"Private Insurance"</span>,</span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insuranceMedicaid"</span> <span class="sc">~</span> <span class="st">"Medicaid"</span>,</span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"insuranceOther"</span> <span class="sc">~</span> <span class="st">"Other Insurance"</span>,</span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"comorbidity_score"</span> <span class="sc">~</span> <span class="st">"Comorbidity Score"</span>,</span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"emergency_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Emergency Admission"</span>,</span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"weekend_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Weekend Admission"</span>,</span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a>    term <span class="sc">==</span> <span class="st">"night_admissionTRUE"</span> <span class="sc">~</span> <span class="st">"Night Admission"</span>,</span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot</span></span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fixed_effects, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> <span class="fu">reorder</span>(term, estimate))) <span class="sc">+</span></span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high), </span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> colors<span class="sc">$</span>red<span class="sc">$</span><span class="st">`</span><span class="at">600</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Fixed Effects from GLMM"</span>,</span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each point represents the estimated effect on log-odds of receiving comprehensive care"</span>,</span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Effect Size (95% CI)"</span>,</span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predictor"</span></span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-269"><a href="#cb29-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-270"><a href="#cb29-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicted Probabilities by Covariate Groups</span></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a>Here, we use the emmeans package to estimate marginal predicted probabilities for selected covariates. These represent the expected probability of receiving comprehensive care for each level of a covariate, averaging over the distribution of other covariates in the model. This approach helps isolate the relationship between each covariate and the outcome while controlling for confounding. We visualize these estimates and their 95% confidence intervals, grouped by domain (e.g., race/ethnicity, insurance, medical conditions).</span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predicted_probabilities}</span></span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 12</span></span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate predicted probabilities for each covariate group</span></span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a><span class="co"># Race/Ethnicity</span></span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a>race_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> race_ethnicity, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a>race_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(race_probs) <span class="sc">|&gt;</span></span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Race/Ethnicity"</span>,</span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"aian"</span> <span class="sc">~</span> <span class="st">"AIAN"</span>,</span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"asian"</span> <span class="sc">~</span> <span class="st">"Asian"</span>,</span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"black"</span> <span class="sc">~</span> <span class="st">"Black"</span>,</span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"hispanic"</span> <span class="sc">~</span> <span class="st">"Hispanic"</span>,</span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"nhpi"</span> <span class="sc">~</span> <span class="st">"NHPI"</span>,</span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"other"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a>      race_ethnicity <span class="sc">==</span> <span class="st">"white"</span> <span class="sc">~</span> <span class="st">"White"</span></span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Insurance</span></span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a>insurance_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> insurance, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a>insurance_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(insurance_probs) <span class="sc">|&gt;</span></span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Insurance"</span>,</span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"medicaid"</span> <span class="sc">~</span> <span class="st">"Medicaid"</span>,</span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"private"</span> <span class="sc">~</span> <span class="st">"Private"</span>,</span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"state_provided"</span> <span class="sc">~</span> <span class="st">"State-Provided"</span>,</span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a>      insurance <span class="sc">==</span> <span class="st">"uninsured"</span> <span class="sc">~</span> <span class="st">"Uninsured"</span>,</span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a><span class="co"># Medical Conditions</span></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a>conditions_probs <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(model, <span class="sc">~</span> multiple_gestation <span class="sc">+</span> placenta_previa <span class="sc">+</span> gest_hypertension <span class="sc">+</span> preeclampsia, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a>conditions_probs_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(conditions_probs) <span class="sc">|&gt;</span></span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Medical Conditions"</span>,</span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a>      multiple_gestation <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Multiple Gestation"</span>,</span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>      placenta_previa <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Placenta Previa"</span>,</span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a>      gest_hypertension <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Gestational Hypertension"</span>,</span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>      preeclampsia <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Preeclampsia"</span>,</span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"No Medical Conditions"</span></span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove duplicates where multiple conditions are true</span></span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(category, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all predictions</span></span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>all_probs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a>  race_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL),</span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a>  insurance_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL),</span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a>  conditions_probs_df <span class="sc">|&gt;</span> <span class="fu">select</span>(group, category, prob, asymp.LCL, asymp.UCL)</span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a><span class="co"># Create faceted plot</span></span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_probs, <span class="fu">aes</span>(<span class="at">x =</span> prob, <span class="at">y =</span> <span class="fu">reorder</span>(category, prob))) <span class="sc">+</span></span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> asymp.LCL, <span class="at">xmax =</span> asymp.UCL), </span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> group, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Probability of Receiving Comprehensive Care"</span>,</span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"By Covariate Groups"</span>,</span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predicted Probability (95% CI)"</span>,</span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Category"</span></span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## Provider-Level Random Effects</span></span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>We visualize the provider-level random intercepts, which represent the estimated deviation of each provider from the overall mean (intercept) after accounting for the fixed effects in the model. This helps reveal between-provider variability and can identify providers whose outcomes are systematically higher or lower than expected. The dashed vertical line at zero indicates the overall average; providers to the right have higher-than-average effects, and those to the left are lower.</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r random_effects}</span></span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Get random effects</span></span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model, <span class="at">condVar =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a>random_effects_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(random_effects)</span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot of random effects</span></span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(random_effects_data, <span class="fu">aes</span>(<span class="at">x =</span> condval, <span class="at">y =</span> <span class="fu">reorder</span>(grp, condval))) <span class="sc">+</span></span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> condval <span class="sc">-</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">attr</span>(random_effects<span class="sc">$</span>provider_id, <span class="st">"postVar"</span>)[<span class="dv">1</span>,<span class="dv">1</span>,]), </span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a>                     <span class="at">xmax =</span> condval <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="fu">attr</span>(random_effects<span class="sc">$</span>provider_id, <span class="st">"postVar"</span>)[<span class="dv">1</span>,<span class="dv">1</span>,])), </span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>                 <span class="at">height =</span> <span class="fl">0.2</span>, <span class="at">color =</span> colors<span class="sc">$</span>slate<span class="sc">$</span><span class="st">`</span><span class="at">300</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> colors<span class="sc">$</span>blue<span class="sc">$</span><span class="st">`</span><span class="at">500</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> colors<span class="sc">$</span>red<span class="sc">$</span><span class="st">`</span><span class="at">600</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Random Effects by Provider"</span>,</span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each point represents the provider-specific deviation from the overall intercept"</span>,</span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Provider-Specific Effect (95% CI)"</span>,</span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Provider ID"</span></span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-392"><a href="#cb29-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-393"><a href="#cb29-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r model_summary}</span></span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a><span class="co"># Print model summary</span></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interaction Effects</span></span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a>The <span class="in">`emmeans`</span> package can also be used to help visualize interaction effects. Let's simulate some data with an interaction effect.</span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-402"><a href="#cb29-402" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interaction Between Categorical and Continuous Variable</span></span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a>In this example, we simulate data to study how different exercise programs might be more or less effective depending on a person's starting fitness level. We have:</span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A categorical predictor: Type of exercise program</span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>High-Intensity Interval Training (HIIT): Short bursts of intense exercise followed by rest</span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Strength Training: Weight lifting and resistance exercises</span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Cardio: Steady-state aerobic exercise like jogging or cycling</span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A continuous predictor: Baseline fitness level (on a 1-10 scale)</span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>An outcome: Weight loss in pounds</span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a>The key question is whether the effectiveness of each program depends on how fit someone is when they start. For example, HIIT might be more effective for people who are already somewhat fit, while Cardio might be better for beginners. The relationship between program type and weight loss changes depends on baseline fitness.</span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a>Each program has:</span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A baseline effectiveness (how much weight loss we expect at average fitness levels)</span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A different rate of effectiveness based on baseline fitness (how much more or less effective it becomes as fitness changes)</span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Some random variation to account for individual differences</span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r interaction_effects}</span></span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data with an interaction effect</span></span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb29-427"><a href="#cb29-427" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb29-428"><a href="#cb29-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data for program × fitness interaction</span></span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a>ix_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Categorical predictor: Exercise program type</span></span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">program =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"HIIT"</span>, <span class="st">"Strength Training"</span>, <span class="st">"Cardio"</span>), </span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continuous predictor: Baseline fitness level (1-10 scale)</span></span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_fitness =</span> <span class="fu">runif</span>(n, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">10</span>),</span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some noise</span></span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create interaction effect</span></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Center the baseline fitness</span></span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_fitness_centered =</span> baseline_fitness <span class="sc">-</span> <span class="fu">mean</span>(baseline_fitness),</span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different slopes for different programs</span></span>
<span id="cb29-444"><a href="#cb29-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">fitness_effect =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-445"><a href="#cb29-445" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"HIIT"</span> <span class="sc">~</span> <span class="fl">0.8</span>,</span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Strength Training"</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Cardio"</span> <span class="sc">~</span> <span class="fl">0.3</span></span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Different intercepts for different programs</span></span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">program_effect =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"HIIT"</span> <span class="sc">~</span> <span class="fl">8.0</span>,</span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Strength Training"</span> <span class="sc">~</span> <span class="fl">6.0</span>,</span>
<span id="cb29-453"><a href="#cb29-453" aria-hidden="true" tabindex="-1"></a>      program <span class="sc">==</span> <span class="st">"Cardio"</span> <span class="sc">~</span> <span class="fl">4.0</span></span>
<span id="cb29-454"><a href="#cb29-454" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate outcome: Weight loss in pounds</span></span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight_loss =</span> program_effect <span class="sc">+</span> (fitness_effect <span class="sc">*</span> baseline_fitness_centered) <span class="sc">+</span> error</span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a>Let's fit a model to the simulated data.</span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r interaction_model}</span></span>
<span id="cb29-462"><a href="#cb29-462" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-463"><a href="#cb29-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-464"><a href="#cb29-464" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(weight_loss <span class="sc">~</span> program <span class="sc">*</span> baseline_fitness_centered, <span class="at">data =</span> ix_data)</span>
<span id="cb29-465"><a href="#cb29-465" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">tidy</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a>We get results back. We have "main effects" for the program type and the baseline fitness level, and an interaction effect between the two.</span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a>Centering helps: The intercept represents the expected weight loss when baseline fitness is at its mean. </span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a>The <span class="in">`emmeans`</span> package can help us interpret. Let's get it to give us the predicted weight loss at the average fitness level.</span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r interaction_plot}</span></span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the interaction</span></span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(model, <span class="sc">~</span> program <span class="sc">|</span> baseline_fitness_centered)</span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a>We see that this lines up with our model results:</span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Cardio: 4.16 lbs (intercept)</span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>HIIT: 7.89 lbs  (4.16 + 3.73 = 7.89)</span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Strength Training: 6.08 lbs (4.16 + 1.92 = 6.08)</span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a>But what if we want to see the relationship between program type and weight loss at different baseline fitness levels? Let's create a plot that shows how weight loss changes across the full range of baseline fitness for each program.</span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`emmip()`</span> (expected means interaction plot)to plot the predicted weight loss by program type at different baseline fitness levels. We add some text to the plot to show the slopes for each program.</span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r interaction_plot_2}</span></span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a><span class="co"># Create baseline fitness values in the original (uncentered) scale</span></span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-497"><a href="#cb29-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-498"><a href="#cb29-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Get centered values based on the observed data range</span></span>
<span id="cb29-499"><a href="#cb29-499" aria-hidden="true" tabindex="-1"></a>centered_range <span class="ot">&lt;-</span> <span class="fu">range</span>(ix_data<span class="sc">$</span>baseline_fitness <span class="sc">-</span> <span class="fu">mean</span>(ix_data<span class="sc">$</span>baseline_fitness))</span>
<span id="cb29-500"><a href="#cb29-500" aria-hidden="true" tabindex="-1"></a>centered_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(centered_range[<span class="dv">1</span>], centered_range[<span class="dv">2</span>], <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a><span class="fu">emmip</span>(</span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a>  program <span class="sc">~</span> baseline_fitness_centered,</span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">baseline_fitness_centered =</span> centered_vals),</span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Weight Loss by Program and Baseline Fitness"</span>,</span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Baseline Fitness Level (Centered)"</span>,</span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Weight Loss (pounds)"</span>,</span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Program Type"</span></span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">4.5</span>, <span class="at">label =</span> <span class="st">"Cardio slope: 0.30"</span>, <span class="at">color =</span> <span class="st">"#F8766D"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">10.5</span>, <span class="at">label =</span> <span class="st">"HIIT slope: 0.79"</span>, <span class="at">color =</span> <span class="st">"#00BA38"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">y =</span> <span class="fl">7.5</span>, <span class="at">label =</span> <span class="st">"Strength slope: 0.56"</span>, <span class="at">color =</span> <span class="st">"#619CFF"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a>I find this a lot easier to interpret than the table of results. "Seeing is believing."</span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-531"><a href="#cb29-531" aria-hidden="true" tabindex="-1"></a><span class="fu">## More Complexity: Categorical by Continuous by Continuous Interaction</span></span>
<span id="cb29-532"><a href="#cb29-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a>Let's simulate data to get a sense of a complex set of interactions. </span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a>We will create a simulated dataset that explores how lung function is influenced by age, air pollution exposure, and smoking status. Both age and pollution independently reduce lung function, but the negative effect of pollution becomes more pronounced as people get older, so pollution is more damaging to lung function in older adults than in younger ones. Moreover, smoking increases the effect of pollution on lung function.</span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`fev1`</span> = forced expiratory volume in one second</span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`age`</span> = age, which can be 30-80</span>
<span id="cb29-539"><a href="#cb29-539" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`pm25`</span> = particulate matter exposure</span>
<span id="cb29-540"><a href="#cb29-540" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`is_smoker`</span> = whether the person is a smoker</span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r continuous_interaction_data}</span></span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">30</span>, <span class="dv">80</span>)              <span class="co"># Age 30–80</span></span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a>pm25 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">5</span>, <span class="dv">35</span>)              <span class="co"># PM2.5 range</span></span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a>interaction_effect <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.01</span>          <span class="co"># Base moderation: steeper slope with age</span></span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a><span class="co"># Add smoking status (binary)</span></span>
<span id="cb29-552"><a href="#cb29-552" aria-hidden="true" tabindex="-1"></a><span class="co"># More likely to have smoking history as age increases</span></span>
<span id="cb29-553"><a href="#cb29-553" aria-hidden="true" tabindex="-1"></a>smoking_prob <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="sc">+</span> (age <span class="sc">-</span> <span class="dv">30</span>)<span class="sc">/</span><span class="dv">100</span>  <span class="co"># Probability increases with age</span></span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a>is_smoker <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, smoking_prob)</span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Create age-dependent error term (more variation with age)</span></span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a>age_error <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">0.2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> (age <span class="sc">-</span> <span class="dv">30</span>)<span class="sc">/</span><span class="dv">50</span>))  <span class="co"># Error increases with age</span></span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome: base lung function + age effect + pollution effect + </span></span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a><span class="co"># two-way interactions + three-way interaction + smoking effect</span></span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a><span class="co"># Please note how are simulated data looks like the model we are going to estimate.</span></span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulating data is a great way to undrestand how models work.</span></span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a><span class="co"># In fact, if you uncenter the below model, you will see that the coefficients are very close to what we define below.</span></span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a>fev1 <span class="ot">&lt;-</span> <span class="fl">4.5</span> <span class="sc">-</span> <span class="co"># intercept</span></span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.02</span><span class="sc">*</span>age <span class="sc">-</span> <span class="co"># age effect</span></span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.03</span><span class="sc">*</span>pm25 <span class="sc">+</span> <span class="co"># pollution effect</span></span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a>        interaction_effect <span class="sc">*</span> age <span class="sc">*</span> pm25 <span class="sc">-</span>  <span class="co"># age × pollution</span></span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.5</span><span class="sc">*</span>is_smoker <span class="sc">+</span>                    <span class="co"># smoking main effect</span></span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.02</span><span class="sc">*</span>age<span class="sc">*</span>is_smoker <span class="sc">+</span>               <span class="co"># age × smoking</span></span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.01</span><span class="sc">*</span>pm25<span class="sc">*</span>is_smoker <span class="sc">+</span>              <span class="co"># pollution × smoking</span></span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fl">0.005</span><span class="sc">*</span>age<span class="sc">*</span>pm25<span class="sc">*</span>is_smoker <span class="sc">+</span>        <span class="co"># three-way interaction</span></span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a>        age_error</span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame</span></span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(age, pm25, fev1, is_smoker)</span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a>A starting point for an interaction analysis is to color code by group and look at the trends. Let's create age bins and plot out the trends, faceting by smoker status.</span>
<span id="cb29-580"><a href="#cb29-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-581"><a href="#cb29-581" aria-hidden="true" tabindex="-1"></a>We clearly see a slope difference by age. We also see that all the slopes of smokers appear to be steeper than the slopes of non-smokers.</span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{r continuous_interaction_plot_2}</span></span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>), </span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70+"</span>)),</span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> fev1, <span class="at">color =</span> age_group)) <span class="sc">+</span></span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> smoking_status) <span class="sc">+</span></span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Lung Function by Air Pollution and Age Group"</span>,</span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Faceted by Smoking Status"</span>,</span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PM2.5 Exposure"</span>,</span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"FEV1 (L)"</span>,</span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Age Group"</span></span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-609"><a href="#cb29-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-610"><a href="#cb29-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Show variation by age group and smoking status</span></span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>), </span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a>                   <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70+"</span>)),</span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age_group, smoking_status) <span class="sc">|&gt;</span></span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb29-619"><a href="#cb29-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_fev1 =</span> <span class="fu">mean</span>(fev1),</span>
<span id="cb29-620"><a href="#cb29-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_fev1 =</span> <span class="fu">sd</span>(fev1),</span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_fev1 =</span> <span class="fu">min</span>(fev1),</span>
<span id="cb29-622"><a href="#cb29-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_fev1 =</span> <span class="fu">max</span>(fev1),</span>
<span id="cb29-623"><a href="#cb29-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a>Now let's center our variables and fit a model with the three-way interaction.</span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r continuous_interaction_model}</span></span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb29-634"><a href="#cb29-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-635"><a href="#cb29-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25_centered =</span> pm25 <span class="sc">-</span> <span class="fu">mean</span>(pm25),</span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_centered =</span> age <span class="sc">-</span> <span class="fu">mean</span>(age)</span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(fev1 <span class="sc">~</span> pm25_centered <span class="sc">*</span> age_centered <span class="sc">*</span> is_smoker, <span class="at">data =</span> data)</span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">tidy</span>() <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a>We see that the interaction terms in our regression model are statistically significant, but interpreting them directly from the table is very difficult. This is especially true in models with two or more continuous predictors interacting, and even more so when one of them is also interacting with a binary group.</span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a>Take the main effects: <span class="in">`pm25_centered`</span> and <span class="in">`age_centered`</span>. These coefficients only describe the effect of PM2.5 or age at the average level of the other variable. For example, the coefficient for PM2.5 tells us how pollution affects FEV1 only at the mean age in our sample. That’s not very useful unless you already know what the mean is, and even then, it’s just a narrow slice of the story.</span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a>Now add in interaction terms like <span class="in">`pm25`</span> × <span class="in">`age`</span> or <span class="in">`pm25`</span> × <span class="in">`age`</span> × <span class="in">`is_smoker`</span>, and things get more abstract. What does a coefficient of –0.01 for <span class="in">`pm25`</span> × <span class="in">`age`</span> actually mean? Technically, it means the effect of PM2.5 on lung function gets more negative as age increases, but:</span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>How much more?</span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Is that change clinically meaningful?</span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Does the slope actually flip direction at some point?</span>
<span id="cb29-652"><a href="#cb29-652" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Is the effect stronger in smokers than non-smokers?</span>
<span id="cb29-653"><a href="#cb29-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a>You could try to work this out by multiplying coefficients in your head, but if you're like me, then you're not smart enough. Better to use visualization to help.</span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a><span class="in">`emmeans`</span> can help us by generating predicted values and estimated trends. It also allows us to probe the model and "un-center" the data for interpretation. </span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a>For example, we can explore how the slope of PM2.5 on FEV1 changes at different ages, and see how those slopes differ by smoking status. Using <span class="in">`emtrends()`</span>, we can even extract the actual slope estimates by subgroup, turning abstract interactions into tangible comparisons.</span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-660"><a href="#cb29-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-661"><a href="#cb29-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r continuous_interaction_plot_3}</span></span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.width: 12</span></span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a><span class="co"># Get centering values</span></span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a>mean_age <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>age)</span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a>mean_pm25 <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>pm25)</span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-669"><a href="#cb29-669" aria-hidden="true" tabindex="-1"></a><span class="co"># Define values for uncentered age and PM2.5</span></span>
<span id="cb29-670"><a href="#cb29-670" aria-hidden="true" tabindex="-1"></a>age_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">80</span>)</span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a>pm25_vals <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">35</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a><span class="co"># Centered versions to use in emmip</span></span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a>age_centered_vals <span class="ot">&lt;-</span> age_vals <span class="sc">-</span> mean_age</span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a>pm25_centered_vals <span class="ot">&lt;-</span> pm25_vals <span class="sc">-</span> mean_pm25</span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Get predicted values with emmip, grouped by smoking status</span></span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">emmip</span>(</span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a>  age_centered <span class="sc">~</span> pm25_centered <span class="sc">|</span> is_smoker,</span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(</span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_centered =</span> age_centered_vals,</span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25_centered =</span> pm25_centered_vals,</span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_smoker =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a>  <span class="at">plotit =</span> <span class="cn">FALSE</span></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncenter for plotting</span></span>
<span id="cb29-691"><a href="#cb29-691" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> pred_data <span class="sc">|&gt;</span></span>
<span id="cb29-692"><a href="#cb29-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age_centered <span class="sc">+</span> mean_age,</span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm25 =</span> pm25_centered <span class="sc">+</span> mean_pm25,</span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoker_label =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>)</span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Get slopes of PM2.5 at each age × smoking status</span></span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a>slopes <span class="ot">&lt;-</span> <span class="fu">emtrends</span>(</span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> age_centered <span class="sc">*</span> is_smoker,</span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> <span class="st">"pm25_centered"</span>,</span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a>  <span class="at">at =</span> <span class="fu">list</span>(<span class="at">age_centered =</span> age_centered_vals, <span class="at">is_smoker =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> age_centered <span class="sc">+</span> mean_age,</span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoker_label =</span> <span class="fu">ifelse</span>(is_smoker <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Smoker"</span>, <span class="st">"Non-smoker"</span>),</span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Slope: "</span>, <span class="fu">round</span>(pm25_centered.trend, <span class="dv">3</span>))</span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Plot</span></span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_data, <span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> yvar, <span class="at">color =</span> <span class="fu">factor</span>(age), <span class="at">group =</span> <span class="fu">interaction</span>(age, smoker_label))) <span class="sc">+</span></span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pred_data <span class="sc">|&gt;</span></span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(age, smoker_label) <span class="sc">|&gt;</span></span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(pm25) <span class="sc">|&gt;</span></span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(slopes, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"smoker_label"</span>)),</span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> pm25, <span class="at">y =</span> yvar, <span class="at">label =</span> label, <span class="at">color =</span> <span class="fu">factor</span>(age)),</span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>,</span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.5</span>,</span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> smoker_label) <span class="sc">+</span></span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Lung Function by PM2.5 and Age, with Smoking Interaction"</span>,</span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Slopes of PM2.5 Effect Vary by Age and Smoking Status"</span>,</span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PM2.5 (μg/m³)"</span>,</span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted FEV1"</span>,</span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Age"</span></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">min</span>(pm25_vals), <span class="fu">max</span>(pm25_vals) <span class="sc">+</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>